---
title: Bayesian analysis of longitudinal multilevel data using brms and rethinking - part 5  
description: Part 5 of a tutorial showing how to fit an ODE model using Stan.
author: Andreas Handel
date: '2025-02-15'
aliases: 
  - ../longitudinal-multilevel-bayesian-analysis-5/
categories: 
- R
- Data Analysis
- Bayesian
- Stan
image: "featured.png"
---



```{r, include=FALSE, cache=FALSE}
#knitr::read_chunk('generatedata.R')
```

This tutorial continues the series of examples showing how to fit longitudinal data using 
Bayesian multilevel/hierarchical/mixed-effects models.

This tutorial covers the example where the underlying model is given by a set of ordinary differential equations (ODEs).


# The idea

The most common types of models used to describe data are those that are non-mechanistic -- or phenomenological, like [I like to call them](https://www.nature.com/articles/s41577-019-0235-3). What's meant by that is that the model represents a convenient and suitable way to describe the data, but does not try to capture any information about the underlying mechanisms of the system and processes that led to the observed data.

In contrast, mechanistic models are -- very simplified -- representations of the assumed or known underlying processes. As such, they allow incorporation of expert knowledge, and are potentially better at providing a fuller understanding of the system - but also require such a better understanding at the start to even allow using such models. 

That's all I'll say about these models, you can learn more in [this review article I wrote with colleagues](https://www.nature.com/articles/s41577-019-0235-3) or on [this website](https://andreashandel.github.io/SMIcourse/). Both of these resources are immunology-focused, but the general concepts are the same for any subject matter area.

A common way of implementing mechanistic models that describe the dynamics of some system is through ordinary differential equations (ODEs). This is the approach I'll be taking here.


## The ODE model

As a reminder, our outcome/data of interest are virus load time-series trajectories of individuals following infection.

To get an ODE model that can capture the shape of our data, I use a simple basic virus dynamics model. I won't explain this model here, if you want to learn more about these kind of models, see for instance [this short write-up](https://andreashandel.github.io/SMIcourse/A_Few_Simple_Models.html#Simple_Viral_Infection_Model) on my [Simulation Modeling for Immunologists website](https://andreashandel.github.io/SMIcourse/) or [this reference](https://www.nature.com/articles/nri700).

Here are the model equations

$$
\begin{aligned}


\textrm{uninfected cells:} \qquad  \dot U & = -\beta_i UV \\ 
\textrm{infected cells:} \qquad  \dot I & = \beta_i UV - \delta_i I \\
\textrm{virus:} \qquad  \dot V & = \alpha_i I - \eta_i V
\end{aligned}
$$
This model has 4 parameters, each is indexed by $i$ to indicate that it can differ between individuals. For any ODE model, one needs to not only specify the model parameters but also the starting values of each quantity. To keep things simple, below I assume that the number of uninfected cells and infected cells is known and the same for each individual, and that the virus load is given by the experimental conditions, i.e. the dose. More generally, it would be possible to let the starting values vary and estimate them from the data.

While the model tracks the dynamics of 3 quantities, we only have data on one, namely the virus $V$. The time-series obtained for $V$ by solving these ODEs is what is now assumed to be the average trajectory, namely what we formerlly called $\mu$ in the statistical model.


## The new statistical model

I assume you read through the previous posts, at least [part 1]() which describes the overall setup and the models to be explored. If you didn't, the following won't make much sense üòÅ.

These are the components of the new model, now with an ODE model describing the deterministic part.

I'm not sure what the best mathematical notation is, here is an option.

$$
\begin{aligned}
\textrm{Outcome} \\
Y_{i,t}   \sim \mathrm{Normal}\left(\log(V_{i,t}), \sigma\right) \\
\\
\textrm{ODE model defining V} \\
\dot U  = -\beta_i UV \\ 
\dot I  = \beta_i UV - \gamma_i I \\
\dot V  = \alpha_i I - \eta_i V \\
\\
\textrm{Deterministic models for main parameters} \\
\alpha_{i}   =  a_{0,i} + a_1 \left(\log (D_i) - \log (D_m)\right)  \\
\beta_{i}   =  b_{0,i} + b_1 \left(\log (D_i) - \log (D_m)\right) \\
\gamma_{i}   =  g_{0,i} + g_1 \left(\log (D_i) - \log (D_m)\right) \\
\eta_{i}   =  e_{0,i} + e_1 \left(\log (D_i) - \log (D_m)\right) \\
\end{aligned}
$$

This model is similar in structure to the previous non-mechanistic ones. Each model parameter depends on the dose as well as potentially on individual differences. The main difference is that to obtain the time-series for the outcome (here, virus load), we need to integrate the ODE model at each iteration.


To fully specify the model, we need to give all parameters distributions. 
Here are the distributions for the population-level parameters. These do not vary between individuals.


$$
\begin{aligned}
\textrm{population-level priors} \\
\sigma  \sim \mathrm{HalfCauchy}(0,1)  \\
a_1 \sim \mathrm{Normal}(0.1, 0.1) \\
b_1 \sim \mathrm{Normal}(-0.1, 0.1) \\
g_1 \sim \mathrm{Normal}(0.1, 0.1) \\
e_1 \sim \mathrm{Normal}(-0.1, 0.1) \\
\end{aligned}
$$


In addition, we allow some parameters to differ between individuals, and we'll implement hyper-parameters to allow these values to inform each other across individuals. This is again the adaptive prior concept from earlier.


$$
\begin{aligned}
\textrm{individal-level priors} \\
a_{0,i} \sim \mathrm{Normal}(\mu_a, \sigma_a) \\
b_{0,i}  \sim \mathrm{Normal}(\mu_b, \sigma_b) \\
g_{0,i} \sim \mathrm{Normal}(\mu_g, \sigma_g) \\
e_{0,i}  \sim \mathrm{Normal}(\mu_e, \sigma_e) \\
\\
\textrm{hyper priors} \\
\mu_a  \sim \mathrm{Normal}(3, 1) \\
\mu_b  \sim \mathrm{Normal}(1, 1) \\
\mu_g  \sim \mathrm{Normal}(3, 1) \\
\mu_e  \sim \mathrm{Normal}(1, 1) \\
\sigma_a  \sim \mathrm{HalfCauchy}(0,1)  \\
\sigma_b  \sim \mathrm{HalfCauchy}(0,1)  \\
\sigma_g  \sim \mathrm{HalfCauchy}(0,1)  \\
\sigma_e  \sim \mathrm{HalfCauchy}(0,1)  \\
\end{aligned}
$$

And that's the full model. It looks quite complex to me, even though it only has a very simple ODE and 4 main model parameters. Let's see how we can implement this.


# Model implementation

We previously used the `brms` and `rethinking` R packages to run our `Stan` models in `R`, without having to write `Stan` code. One can use these packages for ODEs, but still has to write some `Stan` code. I decided instead, for flexibility, I'm writing the full model in `Stan` and then fit it through `cmdstanr` in R.

## Stan model code

https://stanpmx.github.io/

https://mpopov.com/tutorials/ode-stan-r/

https://blog.djnavarro.net/posts/2023-05-16_stan-ode/

https://blog.djnavarro.net/posts/2023-05-16_stan-ode/#when-biology-isnt-analytically-tractable

https://mc-stan.org/docs/stan-users-guide/ode-solver.html


https://blog.djnavarro.net/posts/2023-06-10_pop-pk-models/
## cmdstanr code



# Summary and continuation









